{"cells":[{"cell_type":"markdown","metadata":{"id":"1ZvwrjSc3O7v"},"source":["# Multiclass semantic segmentation using DeepLabV3+\n","\n","**Author:** [Soumik Rakshit](http://github.com/soumik12345)\u003cbr\u003e\n","**Date created:** 2021/08/31\u003cbr\u003e\n","**Last modified:** 2021/09/1\u003cbr\u003e\n","**Description:** Implement DeepLabV3+ architecture for Multi-class Semantic Segmentation."]},{"cell_type":"markdown","metadata":{"id":"ghVGMjoF3O73"},"source":["## Introduction\n","\n","Semantic segmentation, with the goal to assign semantic labels to every pixel in an image,\n","is an essential computer vision task. In this example, we implement\n","the **DeepLabV3+** model for multi-class semantic segmentation, a fully-convolutional\n","architecture that performs well on semantic segmentation benchmarks.\n","\n","### References:\n","\n","- [Encoder-Decoder with Atrous Separable Convolution for Semantic Image Segmentation](https://arxiv.org/pdf/1802.02611.pdf)\n","- [Rethinking Atrous Convolution for Semantic Image Segmentation](https://arxiv.org/abs/1706.05587)\n","- [DeepLab: Semantic Image Segmentation with Deep Convolutional Nets, Atrous Convolution, and Fully Connected CRFs](https://arxiv.org/abs/1606.00915)"]},{"cell_type":"markdown","metadata":{"id":"MlZNIJ043O75"},"source":["## Downloading the data\n","\n","We will use the [Crowd Instance-level Human Parsing Dataset](https://arxiv.org/abs/1811.12596)\n","for training our model. The Crowd Instance-level Human Parsing (CIHP) dataset has 38,280 diverse human images.\n","Each image in CIHP is labeled with pixel-wise annotations for 20 categories, as well as instance-level identification.\n","This dataset can be used for the \"human part segmentation\" task."]},{"cell_type":"code","execution_count":1,"metadata":{"executionInfo":{"elapsed":5077,"status":"ok","timestamp":1667401399739,"user":{"displayName":"Deepak Kurup","userId":"12080243808198814348"},"user_tz":240},"id":"q8BAhO_s3O76"},"outputs":[],"source":["import os\n","import cv2\n","import numpy as np\n","from glob import glob\n","from scipy.io import loadmat\n","import matplotlib.pyplot as plt\n","\n","import tensorflow as tf\n","from tensorflow import keras\n","from tensorflow.keras import layers"]},{"cell_type":"code","execution_count":2,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":93517,"status":"ok","timestamp":1667401494690,"user":{"displayName":"Deepak Kurup","userId":"12080243808198814348"},"user_tz":240},"id":"URGbWbuf3O77","outputId":"d6a50822-0915-408b-8964-ca92236683a6"},"outputs":[{"name":"stdout","output_type":"stream","text":["Downloading...\n","From: https://drive.google.com/uc?id=1B9A9UCJYMwTL4oBEo4RZfbMZMaZhKJaz\n","To: /content/instance-level-human-parsing.zip\n","100% 2.91G/2.91G [00:40\u003c00:00, 71.9MB/s]\n"]}],"source":["!gdown https://drive.google.com/uc?id=1B9A9UCJYMwTL4oBEo4RZfbMZMaZhKJaz\n","!unzip -q instance-level-human-parsing.zip"]},{"cell_type":"markdown","metadata":{"id":"8ZvAOIxq3O78"},"source":["## Creating a TensorFlow Dataset\n","\n","Training on the entire CIHP dataset with 38,280 images takes a lot of time, hence we will be using\n","a smaller subset of 200 images for training our model in this example."]},{"cell_type":"code","execution_count":3,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":1442,"status":"ok","timestamp":1667401500057,"user":{"displayName":"Deepak Kurup","userId":"12080243808198814348"},"user_tz":240},"id":"gBNKoOkr3O78","outputId":"25ec21ea-4a9c-4434-b106-f8a2280d506f"},"outputs":[{"name":"stdout","output_type":"stream","text":["Train Dataset: \u003cBatchDataset element_spec=(TensorSpec(shape=(4, 512, 512, 3), dtype=tf.float32, name=None), TensorSpec(shape=(4, 512, 512, 1), dtype=tf.float32, name=None))\u003e\n","Val Dataset: \u003cBatchDataset element_spec=(TensorSpec(shape=(4, 512, 512, 3), dtype=tf.float32, name=None), TensorSpec(shape=(4, 512, 512, 1), dtype=tf.float32, name=None))\u003e\n"]}],"source":["IMAGE_SIZE = 512\n","BATCH_SIZE = 4\n","NUM_CLASSES = 20\n","DATA_DIR = \"./instance-level_human_parsing/instance-level_human_parsing/Training\"\n","NUM_TRAIN_IMAGES = 1000\n","NUM_VAL_IMAGES = 50\n","\n","train_images = sorted(glob(os.path.join(DATA_DIR, \"Images/*\")))[:NUM_TRAIN_IMAGES]\n","train_masks = sorted(glob(os.path.join(DATA_DIR, \"Category_ids/*\")))[:NUM_TRAIN_IMAGES]\n","val_images = sorted(glob(os.path.join(DATA_DIR, \"Images/*\")))[\n","    NUM_TRAIN_IMAGES : NUM_VAL_IMAGES + NUM_TRAIN_IMAGES\n","]\n","val_masks = sorted(glob(os.path.join(DATA_DIR, \"Category_ids/*\")))[\n","    NUM_TRAIN_IMAGES : NUM_VAL_IMAGES + NUM_TRAIN_IMAGES\n","]\n","\n","\n","def read_image(image_path, mask=False):\n","    image = tf.io.read_file(image_path)\n","    if mask:\n","        image = tf.image.decode_png(image, channels=1)\n","        image.set_shape([None, None, 1])\n","        image = tf.image.resize(images=image, size=[IMAGE_SIZE, IMAGE_SIZE])\n","    else:\n","        image = tf.image.decode_png(image, channels=3)\n","        image.set_shape([None, None, 3])\n","        image = tf.image.resize(images=image, size=[IMAGE_SIZE, IMAGE_SIZE])\n","        image = image / 127.5 - 1\n","    return image\n","\n","\n","def load_data(image_list, mask_list):\n","    image = read_image(image_list)\n","    mask = read_image(mask_list, mask=True)\n","    return image, mask\n","\n","\n","def data_generator(image_list, mask_list):\n","    dataset = tf.data.Dataset.from_tensor_slices((image_list, mask_list))\n","    dataset = dataset.map(load_data, num_parallel_calls=tf.data.AUTOTUNE)\n","    dataset = dataset.batch(BATCH_SIZE, drop_remainder=True)\n","    return dataset\n","\n","\n","train_dataset = data_generator(train_images, train_masks)\n","val_dataset = data_generator(val_images, val_masks)\n","\n","print(\"Train Dataset:\", train_dataset)\n","print(\"Val Dataset:\", val_dataset)"]},{"cell_type":"markdown","metadata":{"id":"EzM96aiq3O7-"},"source":["## Building the DeepLabV3+ model\n","\n","DeepLabv3+ extends DeepLabv3 by adding an encoder-decoder structure. The encoder module\n","processes multiscale contextual information by applying dilated convolution at multiple\n","scales, while the decoder module refines the segmentation results along object boundaries.\n","\n","![](https://github.com/lattice-ai/DeepLabV3-Plus/raw/master/assets/deeplabv3_plus_diagram.png)\n","\n","**Dilated convolution:** With dilated convolution, as we go deeper in the network, we can keep the\n","stride constant but with larger field-of-view without increasing the number of parameters\n","or the amount of computation. Besides, it enables larger output feature maps, which is\n","useful for semantic segmentation.\n","\n","The reason for using **Dilated Spatial Pyramid Pooling** is that it was shown that as the\n","sampling rate becomes larger, the number of valid filter weights (i.e., weights that\n","are applied to the valid feature region, instead of padded zeros) becomes smaller."]},{"cell_type":"code","execution_count":4,"metadata":{"executionInfo":{"elapsed":145,"status":"ok","timestamp":1667401513980,"user":{"displayName":"Deepak Kurup","userId":"12080243808198814348"},"user_tz":240},"id":"x3aYy1N23O7_"},"outputs":[],"source":["\n","def convolution_block(\n","    block_input,\n","    num_filters=256,\n","    kernel_size=3,\n","    dilation_rate=1,\n","    padding=\"same\",\n","    use_bias=False,\n","):\n","    x = layers.Conv2D(\n","        num_filters,\n","        kernel_size=kernel_size,\n","        dilation_rate=dilation_rate,\n","        padding=\"same\",\n","        use_bias=use_bias,\n","        kernel_initializer=keras.initializers.HeNormal(),\n","    )(block_input)\n","    x = layers.BatchNormalization()(x)\n","    return tf.nn.relu(x)\n","\n","\n","def DilatedSpatialPyramidPooling(dspp_input):\n","    dims = dspp_input.shape\n","    x = layers.AveragePooling2D(pool_size=(dims[-3], dims[-2]))(dspp_input)\n","    x = convolution_block(x, kernel_size=1, use_bias=True)\n","    out_pool = layers.UpSampling2D(\n","        size=(dims[-3] // x.shape[1], dims[-2] // x.shape[2]), interpolation=\"bilinear\",\n","    )(x)\n","\n","    out_1 = convolution_block(dspp_input, kernel_size=1, dilation_rate=1)\n","    out_6 = convolution_block(dspp_input, kernel_size=3, dilation_rate=6)\n","    out_12 = convolution_block(dspp_input, kernel_size=3, dilation_rate=12)\n","    out_18 = convolution_block(dspp_input, kernel_size=3, dilation_rate=18)\n","\n","    x = layers.Concatenate(axis=-1)([out_pool, out_1, out_6, out_12, out_18])\n","    output = convolution_block(x, kernel_size=1)\n","    return output\n"]},{"cell_type":"markdown","metadata":{"id":"N9b0KVcs3O8B"},"source":["The encoder features are first bilinearly upsampled by a factor 4, and then\n","concatenated with the corresponding low-level features from the network backbone that\n","have the same spatial resolution. For this example, we\n","use a ResNet50 pretrained on ImageNet as the backbone model, and we use\n","the low-level features from the `conv4_block6_2_relu` block of the backbone."]},{"cell_type":"code","execution_count":5,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":6819,"status":"ok","timestamp":1667401524512,"user":{"displayName":"Deepak Kurup","userId":"12080243808198814348"},"user_tz":240},"id":"0SbgRakN3O8B","outputId":"55f553fd-6963-429b-9f49-ab5775a6be97"},"outputs":[{"name":"stdout","output_type":"stream","text":["Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/resnet/resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5\n","94765736/94765736 [==============================] - 1s 0us/step\n","Model: \"model\"\n","__________________________________________________________________________________________________\n"," Layer (type)                   Output Shape         Param #     Connected to                     \n","==================================================================================================\n"," input_1 (InputLayer)           [(None, 512, 512, 3  0           []                               \n","                                )]                                                                \n","                                                                                                  \n"," conv1_pad (ZeroPadding2D)      (None, 518, 518, 3)  0           ['input_1[0][0]']                \n","                                                                                                  \n"," conv1_conv (Conv2D)            (None, 256, 256, 64  9472        ['conv1_pad[0][0]']              \n","                                )                                                                 \n","                                                                                                  \n"," conv1_bn (BatchNormalization)  (None, 256, 256, 64  256         ['conv1_conv[0][0]']             \n","                                )                                                                 \n","                                                                                                  \n"," conv1_relu (Activation)        (None, 256, 256, 64  0           ['conv1_bn[0][0]']               \n","                                )                                                                 \n","                                                                                                  \n"," pool1_pad (ZeroPadding2D)      (None, 258, 258, 64  0           ['conv1_relu[0][0]']             \n","                                )                                                                 \n","                                                                                                  \n"," pool1_pool (MaxPooling2D)      (None, 128, 128, 64  0           ['pool1_pad[0][0]']              \n","                                )                                                                 \n","                                                                                                  \n"," conv2_block1_1_conv (Conv2D)   (None, 128, 128, 64  4160        ['pool1_pool[0][0]']             \n","                                )                                                                 \n","                                                                                                  \n"," conv2_block1_1_bn (BatchNormal  (None, 128, 128, 64  256        ['conv2_block1_1_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv2_block1_1_relu (Activatio  (None, 128, 128, 64  0          ['conv2_block1_1_bn[0][0]']      \n"," n)                             )                                                                 \n","                                                                                                  \n"," conv2_block1_2_conv (Conv2D)   (None, 128, 128, 64  36928       ['conv2_block1_1_relu[0][0]']    \n","                                )                                                                 \n","                                                                                                  \n"," conv2_block1_2_bn (BatchNormal  (None, 128, 128, 64  256        ['conv2_block1_2_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv2_block1_2_relu (Activatio  (None, 128, 128, 64  0          ['conv2_block1_2_bn[0][0]']      \n"," n)                             )                                                                 \n","                                                                                                  \n"," conv2_block1_0_conv (Conv2D)   (None, 128, 128, 25  16640       ['pool1_pool[0][0]']             \n","                                6)                                                                \n","                                                                                                  \n"," conv2_block1_3_conv (Conv2D)   (None, 128, 128, 25  16640       ['conv2_block1_2_relu[0][0]']    \n","                                6)                                                                \n","                                                                                                  \n"," conv2_block1_0_bn (BatchNormal  (None, 128, 128, 25  1024       ['conv2_block1_0_conv[0][0]']    \n"," ization)                       6)                                                                \n","                                                                                                  \n"," conv2_block1_3_bn (BatchNormal  (None, 128, 128, 25  1024       ['conv2_block1_3_conv[0][0]']    \n"," ization)                       6)                                                                \n","                                                                                                  \n"," conv2_block1_add (Add)         (None, 128, 128, 25  0           ['conv2_block1_0_bn[0][0]',      \n","                                6)                                'conv2_block1_3_bn[0][0]']      \n","                                                                                                  \n"," conv2_block1_out (Activation)  (None, 128, 128, 25  0           ['conv2_block1_add[0][0]']       \n","                                6)                                                                \n","                                                                                                  \n"," conv2_block2_1_conv (Conv2D)   (None, 128, 128, 64  16448       ['conv2_block1_out[0][0]']       \n","                                )                                                                 \n","                                                                                                  \n"," conv2_block2_1_bn (BatchNormal  (None, 128, 128, 64  256        ['conv2_block2_1_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv2_block2_1_relu (Activatio  (None, 128, 128, 64  0          ['conv2_block2_1_bn[0][0]']      \n"," n)                             )                                                                 \n","                                                                                                  \n"," conv2_block2_2_conv (Conv2D)   (None, 128, 128, 64  36928       ['conv2_block2_1_relu[0][0]']    \n","                                )                                                                 \n","                                                                                                  \n"," conv2_block2_2_bn (BatchNormal  (None, 128, 128, 64  256        ['conv2_block2_2_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv2_block2_2_relu (Activatio  (None, 128, 128, 64  0          ['conv2_block2_2_bn[0][0]']      \n"," n)                             )                                                                 \n","                                                                                                  \n"," conv2_block2_3_conv (Conv2D)   (None, 128, 128, 25  16640       ['conv2_block2_2_relu[0][0]']    \n","                                6)                                                                \n","                                                                                                  \n"," conv2_block2_3_bn (BatchNormal  (None, 128, 128, 25  1024       ['conv2_block2_3_conv[0][0]']    \n"," ization)                       6)                                                                \n","                                                                                                  \n"," conv2_block2_add (Add)         (None, 128, 128, 25  0           ['conv2_block1_out[0][0]',       \n","                                6)                                'conv2_block2_3_bn[0][0]']      \n","                                                                                                  \n"," conv2_block2_out (Activation)  (None, 128, 128, 25  0           ['conv2_block2_add[0][0]']       \n","                                6)                                                                \n","                                                                                                  \n"," conv2_block3_1_conv (Conv2D)   (None, 128, 128, 64  16448       ['conv2_block2_out[0][0]']       \n","                                )                                                                 \n","                                                                                                  \n"," conv2_block3_1_bn (BatchNormal  (None, 128, 128, 64  256        ['conv2_block3_1_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv2_block3_1_relu (Activatio  (None, 128, 128, 64  0          ['conv2_block3_1_bn[0][0]']      \n"," n)                             )                                                                 \n","                                                                                                  \n"," conv2_block3_2_conv (Conv2D)   (None, 128, 128, 64  36928       ['conv2_block3_1_relu[0][0]']    \n","                                )                                                                 \n","                                                                                                  \n"," conv2_block3_2_bn (BatchNormal  (None, 128, 128, 64  256        ['conv2_block3_2_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv2_block3_2_relu (Activatio  (None, 128, 128, 64  0          ['conv2_block3_2_bn[0][0]']      \n"," n)                             )                                                                 \n","                                                                                                  \n"," conv2_block3_3_conv (Conv2D)   (None, 128, 128, 25  16640       ['conv2_block3_2_relu[0][0]']    \n","                                6)                                                                \n","                                                                                                  \n"," conv2_block3_3_bn (BatchNormal  (None, 128, 128, 25  1024       ['conv2_block3_3_conv[0][0]']    \n"," ization)                       6)                                                                \n","                                                                                                  \n"," conv2_block3_add (Add)         (None, 128, 128, 25  0           ['conv2_block2_out[0][0]',       \n","                                6)                                'conv2_block3_3_bn[0][0]']      \n","                                                                                                  \n"," conv2_block3_out (Activation)  (None, 128, 128, 25  0           ['conv2_block3_add[0][0]']       \n","                                6)                                                                \n","                                                                                                  \n"," conv3_block1_1_conv (Conv2D)   (None, 64, 64, 128)  32896       ['conv2_block3_out[0][0]']       \n","                                                                                                  \n"," conv3_block1_1_bn (BatchNormal  (None, 64, 64, 128)  512        ['conv3_block1_1_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block1_1_relu (Activatio  (None, 64, 64, 128)  0          ['conv3_block1_1_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv3_block1_2_conv (Conv2D)   (None, 64, 64, 128)  147584      ['conv3_block1_1_relu[0][0]']    \n","                                                                                                  \n"," conv3_block1_2_bn (BatchNormal  (None, 64, 64, 128)  512        ['conv3_block1_2_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block1_2_relu (Activatio  (None, 64, 64, 128)  0          ['conv3_block1_2_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv3_block1_0_conv (Conv2D)   (None, 64, 64, 512)  131584      ['conv2_block3_out[0][0]']       \n","                                                                                                  \n"," conv3_block1_3_conv (Conv2D)   (None, 64, 64, 512)  66048       ['conv3_block1_2_relu[0][0]']    \n","                                                                                                  \n"," conv3_block1_0_bn (BatchNormal  (None, 64, 64, 512)  2048       ['conv3_block1_0_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block1_3_bn (BatchNormal  (None, 64, 64, 512)  2048       ['conv3_block1_3_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block1_add (Add)         (None, 64, 64, 512)  0           ['conv3_block1_0_bn[0][0]',      \n","                                                                  'conv3_block1_3_bn[0][0]']      \n","                                                                                                  \n"," conv3_block1_out (Activation)  (None, 64, 64, 512)  0           ['conv3_block1_add[0][0]']       \n","                                                                                                  \n"," conv3_block2_1_conv (Conv2D)   (None, 64, 64, 128)  65664       ['conv3_block1_out[0][0]']       \n","                                                                                                  \n"," conv3_block2_1_bn (BatchNormal  (None, 64, 64, 128)  512        ['conv3_block2_1_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block2_1_relu (Activatio  (None, 64, 64, 128)  0          ['conv3_block2_1_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv3_block2_2_conv (Conv2D)   (None, 64, 64, 128)  147584      ['conv3_block2_1_relu[0][0]']    \n","                                                                                                  \n"," conv3_block2_2_bn (BatchNormal  (None, 64, 64, 128)  512        ['conv3_block2_2_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block2_2_relu (Activatio  (None, 64, 64, 128)  0          ['conv3_block2_2_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv3_block2_3_conv (Conv2D)   (None, 64, 64, 512)  66048       ['conv3_block2_2_relu[0][0]']    \n","                                                                                                  \n"," conv3_block2_3_bn (BatchNormal  (None, 64, 64, 512)  2048       ['conv3_block2_3_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block2_add (Add)         (None, 64, 64, 512)  0           ['conv3_block1_out[0][0]',       \n","                                                                  'conv3_block2_3_bn[0][0]']      \n","                                                                                                  \n"," conv3_block2_out (Activation)  (None, 64, 64, 512)  0           ['conv3_block2_add[0][0]']       \n","                                                                                                  \n"," conv3_block3_1_conv (Conv2D)   (None, 64, 64, 128)  65664       ['conv3_block2_out[0][0]']       \n","                                                                                                  \n"," conv3_block3_1_bn (BatchNormal  (None, 64, 64, 128)  512        ['conv3_block3_1_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block3_1_relu (Activatio  (None, 64, 64, 128)  0          ['conv3_block3_1_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv3_block3_2_conv (Conv2D)   (None, 64, 64, 128)  147584      ['conv3_block3_1_relu[0][0]']    \n","                                                                                                  \n"," conv3_block3_2_bn (BatchNormal  (None, 64, 64, 128)  512        ['conv3_block3_2_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block3_2_relu (Activatio  (None, 64, 64, 128)  0          ['conv3_block3_2_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv3_block3_3_conv (Conv2D)   (None, 64, 64, 512)  66048       ['conv3_block3_2_relu[0][0]']    \n","                                                                                                  \n"," conv3_block3_3_bn (BatchNormal  (None, 64, 64, 512)  2048       ['conv3_block3_3_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block3_add (Add)         (None, 64, 64, 512)  0           ['conv3_block2_out[0][0]',       \n","                                                                  'conv3_block3_3_bn[0][0]']      \n","                                                                                                  \n"," conv3_block3_out (Activation)  (None, 64, 64, 512)  0           ['conv3_block3_add[0][0]']       \n","                                                                                                  \n"," conv3_block4_1_conv (Conv2D)   (None, 64, 64, 128)  65664       ['conv3_block3_out[0][0]']       \n","                                                                                                  \n"," conv3_block4_1_bn (BatchNormal  (None, 64, 64, 128)  512        ['conv3_block4_1_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block4_1_relu (Activatio  (None, 64, 64, 128)  0          ['conv3_block4_1_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv3_block4_2_conv (Conv2D)   (None, 64, 64, 128)  147584      ['conv3_block4_1_relu[0][0]']    \n","                                                                                                  \n"," conv3_block4_2_bn (BatchNormal  (None, 64, 64, 128)  512        ['conv3_block4_2_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block4_2_relu (Activatio  (None, 64, 64, 128)  0          ['conv3_block4_2_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv3_block4_3_conv (Conv2D)   (None, 64, 64, 512)  66048       ['conv3_block4_2_relu[0][0]']    \n","                                                                                                  \n"," conv3_block4_3_bn (BatchNormal  (None, 64, 64, 512)  2048       ['conv3_block4_3_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv3_block4_add (Add)         (None, 64, 64, 512)  0           ['conv3_block3_out[0][0]',       \n","                                                                  'conv3_block4_3_bn[0][0]']      \n","                                                                                                  \n"," conv3_block4_out (Activation)  (None, 64, 64, 512)  0           ['conv3_block4_add[0][0]']       \n","                                                                                                  \n"," conv4_block1_1_conv (Conv2D)   (None, 32, 32, 256)  131328      ['conv3_block4_out[0][0]']       \n","                                                                                                  \n"," conv4_block1_1_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block1_1_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block1_1_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block1_1_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block1_2_conv (Conv2D)   (None, 32, 32, 256)  590080      ['conv4_block1_1_relu[0][0]']    \n","                                                                                                  \n"," conv4_block1_2_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block1_2_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block1_2_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block1_2_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block1_0_conv (Conv2D)   (None, 32, 32, 1024  525312      ['conv3_block4_out[0][0]']       \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block1_3_conv (Conv2D)   (None, 32, 32, 1024  263168      ['conv4_block1_2_relu[0][0]']    \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block1_0_bn (BatchNormal  (None, 32, 32, 1024  4096       ['conv4_block1_0_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv4_block1_3_bn (BatchNormal  (None, 32, 32, 1024  4096       ['conv4_block1_3_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv4_block1_add (Add)         (None, 32, 32, 1024  0           ['conv4_block1_0_bn[0][0]',      \n","                                )                                 'conv4_block1_3_bn[0][0]']      \n","                                                                                                  \n"," conv4_block1_out (Activation)  (None, 32, 32, 1024  0           ['conv4_block1_add[0][0]']       \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block2_1_conv (Conv2D)   (None, 32, 32, 256)  262400      ['conv4_block1_out[0][0]']       \n","                                                                                                  \n"," conv4_block2_1_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block2_1_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block2_1_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block2_1_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block2_2_conv (Conv2D)   (None, 32, 32, 256)  590080      ['conv4_block2_1_relu[0][0]']    \n","                                                                                                  \n"," conv4_block2_2_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block2_2_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block2_2_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block2_2_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block2_3_conv (Conv2D)   (None, 32, 32, 1024  263168      ['conv4_block2_2_relu[0][0]']    \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block2_3_bn (BatchNormal  (None, 32, 32, 1024  4096       ['conv4_block2_3_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv4_block2_add (Add)         (None, 32, 32, 1024  0           ['conv4_block1_out[0][0]',       \n","                                )                                 'conv4_block2_3_bn[0][0]']      \n","                                                                                                  \n"," conv4_block2_out (Activation)  (None, 32, 32, 1024  0           ['conv4_block2_add[0][0]']       \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block3_1_conv (Conv2D)   (None, 32, 32, 256)  262400      ['conv4_block2_out[0][0]']       \n","                                                                                                  \n"," conv4_block3_1_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block3_1_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block3_1_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block3_1_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block3_2_conv (Conv2D)   (None, 32, 32, 256)  590080      ['conv4_block3_1_relu[0][0]']    \n","                                                                                                  \n"," conv4_block3_2_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block3_2_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block3_2_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block3_2_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block3_3_conv (Conv2D)   (None, 32, 32, 1024  263168      ['conv4_block3_2_relu[0][0]']    \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block3_3_bn (BatchNormal  (None, 32, 32, 1024  4096       ['conv4_block3_3_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv4_block3_add (Add)         (None, 32, 32, 1024  0           ['conv4_block2_out[0][0]',       \n","                                )                                 'conv4_block3_3_bn[0][0]']      \n","                                                                                                  \n"," conv4_block3_out (Activation)  (None, 32, 32, 1024  0           ['conv4_block3_add[0][0]']       \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block4_1_conv (Conv2D)   (None, 32, 32, 256)  262400      ['conv4_block3_out[0][0]']       \n","                                                                                                  \n"," conv4_block4_1_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block4_1_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block4_1_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block4_1_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block4_2_conv (Conv2D)   (None, 32, 32, 256)  590080      ['conv4_block4_1_relu[0][0]']    \n","                                                                                                  \n"," conv4_block4_2_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block4_2_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block4_2_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block4_2_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block4_3_conv (Conv2D)   (None, 32, 32, 1024  263168      ['conv4_block4_2_relu[0][0]']    \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block4_3_bn (BatchNormal  (None, 32, 32, 1024  4096       ['conv4_block4_3_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv4_block4_add (Add)         (None, 32, 32, 1024  0           ['conv4_block3_out[0][0]',       \n","                                )                                 'conv4_block4_3_bn[0][0]']      \n","                                                                                                  \n"," conv4_block4_out (Activation)  (None, 32, 32, 1024  0           ['conv4_block4_add[0][0]']       \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block5_1_conv (Conv2D)   (None, 32, 32, 256)  262400      ['conv4_block4_out[0][0]']       \n","                                                                                                  \n"," conv4_block5_1_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block5_1_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block5_1_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block5_1_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block5_2_conv (Conv2D)   (None, 32, 32, 256)  590080      ['conv4_block5_1_relu[0][0]']    \n","                                                                                                  \n"," conv4_block5_2_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block5_2_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block5_2_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block5_2_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block5_3_conv (Conv2D)   (None, 32, 32, 1024  263168      ['conv4_block5_2_relu[0][0]']    \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block5_3_bn (BatchNormal  (None, 32, 32, 1024  4096       ['conv4_block5_3_conv[0][0]']    \n"," ization)                       )                                                                 \n","                                                                                                  \n"," conv4_block5_add (Add)         (None, 32, 32, 1024  0           ['conv4_block4_out[0][0]',       \n","                                )                                 'conv4_block5_3_bn[0][0]']      \n","                                                                                                  \n"," conv4_block5_out (Activation)  (None, 32, 32, 1024  0           ['conv4_block5_add[0][0]']       \n","                                )                                                                 \n","                                                                                                  \n"," conv4_block6_1_conv (Conv2D)   (None, 32, 32, 256)  262400      ['conv4_block5_out[0][0]']       \n","                                                                                                  \n"," conv4_block6_1_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block6_1_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block6_1_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block6_1_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," conv4_block6_2_conv (Conv2D)   (None, 32, 32, 256)  590080      ['conv4_block6_1_relu[0][0]']    \n","                                                                                                  \n"," conv4_block6_2_bn (BatchNormal  (None, 32, 32, 256)  1024       ['conv4_block6_2_conv[0][0]']    \n"," ization)                                                                                         \n","                                                                                                  \n"," conv4_block6_2_relu (Activatio  (None, 32, 32, 256)  0          ['conv4_block6_2_bn[0][0]']      \n"," n)                                                                                               \n","                                                                                                  \n"," average_pooling2d (AveragePool  (None, 1, 1, 256)   0           ['conv4_block6_2_relu[0][0]']    \n"," ing2D)                                                                                           \n","                                                                                                  \n"," conv2d (Conv2D)                (None, 1, 1, 256)    65792       ['average_pooling2d[0][0]']      \n","                                                                                                  \n"," batch_normalization (BatchNorm  (None, 1, 1, 256)   1024        ['conv2d[0][0]']                 \n"," alization)                                                                                       \n","                                                                                                  \n"," conv2d_1 (Conv2D)              (None, 32, 32, 256)  65536       ['conv4_block6_2_relu[0][0]']    \n","                                                                                                  \n"," conv2d_2 (Conv2D)              (None, 32, 32, 256)  589824      ['conv4_block6_2_relu[0][0]']    \n","                                                                                                  \n"," conv2d_3 (Conv2D)              (None, 32, 32, 256)  589824      ['conv4_block6_2_relu[0][0]']    \n","                                                                                                  \n"," conv2d_4 (Conv2D)              (None, 32, 32, 256)  589824      ['conv4_block6_2_relu[0][0]']    \n","                                                                                                  \n"," tf.nn.relu (TFOpLambda)        (None, 1, 1, 256)    0           ['batch_normalization[0][0]']    \n","                                                                                                  \n"," batch_normalization_1 (BatchNo  (None, 32, 32, 256)  1024       ['conv2d_1[0][0]']               \n"," rmalization)                                                                                     \n","                                                                                                  \n"," batch_normalization_2 (BatchNo  (None, 32, 32, 256)  1024       ['conv2d_2[0][0]']               \n"," rmalization)                                                                                     \n","                                                                                                  \n"," batch_normalization_3 (BatchNo  (None, 32, 32, 256)  1024       ['conv2d_3[0][0]']               \n"," rmalization)                                                                                     \n","                                                                                                  \n"," batch_normalization_4 (BatchNo  (None, 32, 32, 256)  1024       ['conv2d_4[0][0]']               \n"," rmalization)                                                                                     \n","                                                                                                  \n"," up_sampling2d (UpSampling2D)   (None, 32, 32, 256)  0           ['tf.nn.relu[0][0]']             \n","                                                                                                  \n"," tf.nn.relu_1 (TFOpLambda)      (None, 32, 32, 256)  0           ['batch_normalization_1[0][0]']  \n","                                                                                                  \n"," tf.nn.relu_2 (TFOpLambda)      (None, 32, 32, 256)  0           ['batch_normalization_2[0][0]']  \n","                                                                                                  \n"," tf.nn.relu_3 (TFOpLambda)      (None, 32, 32, 256)  0           ['batch_normalization_3[0][0]']  \n","                                                                                                  \n"," tf.nn.relu_4 (TFOpLambda)      (None, 32, 32, 256)  0           ['batch_normalization_4[0][0]']  \n","                                                                                                  \n"," concatenate (Concatenate)      (None, 32, 32, 1280  0           ['up_sampling2d[0][0]',          \n","                                )                                 'tf.nn.relu_1[0][0]',           \n","                                                                  'tf.nn.relu_2[0][0]',           \n","                                                                  'tf.nn.relu_3[0][0]',           \n","                                                                  'tf.nn.relu_4[0][0]']           \n","                                                                                                  \n"," conv2d_5 (Conv2D)              (None, 32, 32, 256)  327680      ['concatenate[0][0]']            \n","                                                                                                  \n"," batch_normalization_5 (BatchNo  (None, 32, 32, 256)  1024       ['conv2d_5[0][0]']               \n"," rmalization)                                                                                     \n","                                                                                                  \n"," conv2d_6 (Conv2D)              (None, 128, 128, 48  3072        ['conv2_block3_2_relu[0][0]']    \n","                                )                                                                 \n","                                                                                                  \n"," tf.nn.relu_5 (TFOpLambda)      (None, 32, 32, 256)  0           ['batch_normalization_5[0][0]']  \n","                                                                                                  \n"," batch_normalization_6 (BatchNo  (None, 128, 128, 48  192        ['conv2d_6[0][0]']               \n"," rmalization)                   )                                                                 \n","                                                                                                  \n"," up_sampling2d_1 (UpSampling2D)  (None, 128, 128, 25  0          ['tf.nn.relu_5[0][0]']           \n","                                6)                                                                \n","                                                                                                  \n"," tf.nn.relu_6 (TFOpLambda)      (None, 128, 128, 48  0           ['batch_normalization_6[0][0]']  \n","                                )                                                                 \n","                                                                                                  \n"," concatenate_1 (Concatenate)    (None, 128, 128, 30  0           ['up_sampling2d_1[0][0]',        \n","                                4)                                'tf.nn.relu_6[0][0]']           \n","                                                                                                  \n"," conv2d_7 (Conv2D)              (None, 128, 128, 25  700416      ['concatenate_1[0][0]']          \n","                                6)                                                                \n","                                                                                                  \n"," batch_normalization_7 (BatchNo  (None, 128, 128, 25  1024       ['conv2d_7[0][0]']               \n"," rmalization)                   6)                                                                \n","                                                                                                  \n"," tf.nn.relu_7 (TFOpLambda)      (None, 128, 128, 25  0           ['batch_normalization_7[0][0]']  \n","                                6)                                                                \n","                                                                                                  \n"," conv2d_8 (Conv2D)              (None, 128, 128, 25  589824      ['tf.nn.relu_7[0][0]']           \n","                                6)                                                                \n","                                                                                                  \n"," batch_normalization_8 (BatchNo  (None, 128, 128, 25  1024       ['conv2d_8[0][0]']               \n"," rmalization)                   6)                                                                \n","                                                                                                  \n"," tf.nn.relu_8 (TFOpLambda)      (None, 128, 128, 25  0           ['batch_normalization_8[0][0]']  \n","                                6)                                                                \n","                                                                                                  \n"," up_sampling2d_2 (UpSampling2D)  (None, 512, 512, 25  0          ['tf.nn.relu_8[0][0]']           \n","                                6)                                                                \n","                                                                                                  \n"," conv2d_9 (Conv2D)              (None, 512, 512, 20  5140        ['up_sampling2d_2[0][0]']        \n","                                )                                                                 \n","                                                                                                  \n","==================================================================================================\n","Total params: 11,857,236\n","Trainable params: 11,824,500\n","Non-trainable params: 32,736\n","__________________________________________________________________________________________________\n"]}],"source":["\n","def DeeplabV3Plus(image_size, num_classes):\n","    model_input = keras.Input(shape=(image_size, image_size, 3))\n","    resnet50 = keras.applications.ResNet50(\n","        weights=\"imagenet\", include_top=False, input_tensor=model_input\n","    )\n","    x = resnet50.get_layer(\"conv4_block6_2_relu\").output\n","    x = DilatedSpatialPyramidPooling(x)\n","\n","    input_a = layers.UpSampling2D(\n","        size=(image_size // 4 // x.shape[1], image_size // 4 // x.shape[2]),\n","        interpolation=\"bilinear\",\n","    )(x)\n","    input_b = resnet50.get_layer(\"conv2_block3_2_relu\").output\n","    input_b = convolution_block(input_b, num_filters=48, kernel_size=1)\n","\n","    x = layers.Concatenate(axis=-1)([input_a, input_b])\n","    x = convolution_block(x)\n","    x = convolution_block(x)\n","    x = layers.UpSampling2D(\n","        size=(image_size // x.shape[1], image_size // x.shape[2]),\n","        interpolation=\"bilinear\",\n","    )(x)\n","    model_output = layers.Conv2D(num_classes, kernel_size=(1, 1), padding=\"same\")(x)\n","    return keras.Model(inputs=model_input, outputs=model_output)\n","\n","\n","model = DeeplabV3Plus(image_size=IMAGE_SIZE, num_classes=NUM_CLASSES)\n","model.summary()"]},{"cell_type":"markdown","metadata":{"id":"uLmG7TcH3O8C"},"source":["## Training\n","\n","We train the model using sparse categorical crossentropy as the loss function, and\n","Adam as the optimizer."]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true,"base_uri":"https://localhost:8080/"},"id":"_HeQtiHU3O8D"},"outputs":[{"name":"stdout","output_type":"stream","text":["Epoch 1/25\n","250/250 [==============================] - 7142s 29s/step - loss: 1.1814 - accuracy: 0.6409 - val_loss: 2.1067 - val_accuracy: 0.5960\n","Epoch 2/25\n","250/250 [==============================] - 7129s 29s/step - loss: 0.9575 - accuracy: 0.6962 - val_loss: 2.0992 - val_accuracy: 0.5967\n","Epoch 3/25\n","250/250 [==============================] - 7177s 29s/step - loss: 0.8596 - accuracy: 0.7238 - val_loss: 1.5578 - val_accuracy: 0.5296\n","Epoch 4/25\n","132/250 [==============\u003e...............] - ETA: 55:04 - loss: 0.8104 - accuracy: 0.7417"]}],"source":["loss = keras.losses.SparseCategoricalCrossentropy(from_logits=True)\n","model.compile(\n","    optimizer=keras.optimizers.Adam(learning_rate=0.001),\n","    loss=loss,\n","    metrics=[\"accuracy\"],\n",")\n","\n","history = model.fit(train_dataset, validation_data=val_dataset, epochs=25)\n","\n","plt.plot(history.history[\"loss\"])\n","plt.title(\"Training Loss\")\n","plt.ylabel(\"loss\")\n","plt.xlabel(\"epoch\")\n","plt.show()\n","\n","plt.plot(history.history[\"accuracy\"])\n","plt.title(\"Training Accuracy\")\n","plt.ylabel(\"accuracy\")\n","plt.xlabel(\"epoch\")\n","plt.show()\n","\n","plt.plot(history.history[\"val_loss\"])\n","plt.title(\"Validation Loss\")\n","plt.ylabel(\"val_loss\")\n","plt.xlabel(\"epoch\")\n","plt.show()\n","\n","plt.plot(history.history[\"val_accuracy\"])\n","plt.title(\"Validation Accuracy\")\n","plt.ylabel(\"val_accuracy\")\n","plt.xlabel(\"epoch\")\n","plt.show()"]},{"cell_type":"markdown","metadata":{"id":"AimOvPuh3O8E"},"source":["## Inference using Colormap Overlay\n","\n","The raw predictions from the model represent a one-hot encoded tensor of shape `(N, 512, 512, 20)`\n","where each one of the 20 channels is a binary mask corresponding to a predicted label.\n","In order to visualize the results, we plot them as RGB segmentation masks where each pixel\n","is represented by a unique color corresponding to the particular label predicted. We can easily\n","find the color corresponding to each label from the `human_colormap.mat` file provided as part\n","of the dataset. We would also plot an overlay of the RGB segmentation mask on the input image as\n","this further helps us to identify the different categories present in the image more intuitively."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"E4uJbses3O8E"},"outputs":[],"source":["# Loading the Colormap\n","colormap = loadmat(\n","    \"./instance-level_human_parsing/instance-level_human_parsing/human_colormap.mat\"\n",")[\"colormap\"]\n","colormap = colormap * 100\n","colormap = colormap.astype(np.uint8)\n","\n","\n","def infer(model, image_tensor):\n","    predictions = model.predict(np.expand_dims((image_tensor), axis=0))\n","    predictions = np.squeeze(predictions)\n","    predictions = np.argmax(predictions, axis=2)\n","    return predictions\n","\n","\n","def decode_segmentation_masks(mask, colormap, n_classes):\n","    r = np.zeros_like(mask).astype(np.uint8)\n","    g = np.zeros_like(mask).astype(np.uint8)\n","    b = np.zeros_like(mask).astype(np.uint8)\n","    for l in range(0, n_classes):\n","        idx = mask == l\n","        r[idx] = colormap[l, 0]\n","        g[idx] = colormap[l, 1]\n","        b[idx] = colormap[l, 2]\n","    rgb = np.stack([r, g, b], axis=2)\n","    return rgb\n","\n","\n","def get_overlay(image, colored_mask):\n","    image = tf.keras.preprocessing.image.array_to_img(image)\n","    image = np.array(image).astype(np.uint8)\n","    overlay = cv2.addWeighted(image, 0.35, colored_mask, 0.65, 0)\n","    return overlay\n","\n","\n","def plot_samples_matplotlib(display_list, figsize=(5, 3)):\n","    _, axes = plt.subplots(nrows=1, ncols=len(display_list), figsize=figsize)\n","    for i in range(len(display_list)):\n","        if display_list[i].shape[-1] == 3:\n","            axes[i].imshow(tf.keras.preprocessing.image.array_to_img(display_list[i]))\n","        else:\n","            axes[i].imshow(display_list[i])\n","    plt.show()\n","\n","\n","def plot_predictions(images_list, colormap, model):\n","    for image_file in images_list:\n","        image_tensor = read_image(image_file)\n","        prediction_mask = infer(image_tensor=image_tensor, model=model)\n","        prediction_colormap = decode_segmentation_masks(prediction_mask, colormap, 20)\n","        overlay = get_overlay(image_tensor, prediction_colormap)\n","        plot_samples_matplotlib(\n","            [image_tensor, overlay, prediction_colormap], figsize=(18, 14)\n","        )\n"]},{"cell_type":"markdown","metadata":{"id":"GooI027Q3O8F"},"source":["### Inference on Train Images"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"--wH6jEm3O8F"},"outputs":[],"source":["plot_predictions(train_images[:4], colormap, model=model)\n","\n"]},{"cell_type":"markdown","metadata":{"id":"2ruyKPdy3O8G"},"source":["### Inference on Validation Images\n","\n","You can use the trained model hosted on [Hugging Face Hub](https://huggingface.co/keras-io/deeplabv3p-resnet50) and try the demo on [Hugging Face Spaces](https://huggingface.co/spaces/keras-io/Human-Part-Segmentation)."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"Quhi6zRR3O8G"},"outputs":[],"source":["plot_predictions(val_images[:4], colormap, model=model)"]}],"metadata":{"colab":{"collapsed_sections":[],"name":"","provenance":[{"file_id":"https://github.com/keras-team/keras-io/blob/master/examples/vision/ipynb/deeplabv3_plus.ipynb","timestamp":1667401317181}],"version":""},"kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.7.0"}},"nbformat":4,"nbformat_minor":0}